# Constellos Review - Reusable Workflow
# External repos call this workflow to run AI-powered code reviews
#
# Usage in external repo:
#   jobs:
#     review:
#       uses: constellos/github-agents/.github/workflows/review.yml@main
#       with:
#         pr_number: ${{ github.event.number }}
#         sha: ${{ github.event.pull_request.head.sha }}
#         branch: ${{ github.head_ref }}
#       secrets:
#         CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

name: Constellos Review
on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      sha:
        description: 'Commit SHA to review'
        required: true
        type: string
      branch:
        description: 'Branch name (used for issue extraction)'
        required: true
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'Claude Code OAuth token'
        required: true

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  # Read config and determine which agents to run
  config:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.read.outputs.agents }}
    steps:
      - uses: actions/checkout@v4
      - id: read
        run: |
          if [ -f ".constellos/config.json" ]; then
            AGENTS=$(jq -c '[.agents | to_entries[] | select(.value.enabled) | .key]' .constellos/config.json)
          else
            # Default: run both agents
            AGENTS='["requirements","code-quality"]'
          fi
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT

  # Run each enabled agent in parallel
  review:
    needs: config
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        agent: ${{ fromJson(needs.config.outputs.agents) }}
    steps:
      - uses: actions/checkout@v4

      # Requirements reviewer
      - name: Run requirements review
        id: requirements
        if: matrix.agent == 'requirements'
        uses: constellos/github-agents/.github/actions/requirements-reviewer@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          pr_number: ${{ inputs.pr_number }}
          branch: ${{ inputs.branch }}
          github_token: ${{ github.token }}

      - name: Post requirements comment
        if: matrix.agent == 'requirements'
        uses: constellos/github-agents/.github/actions/review-comment@main
        with:
          review_name: Requirements
          passed: ${{ steps.requirements.outputs.passed }}
          result_json: ${{ steps.requirements.outputs.result }}
          checks_passed: ${{ steps.requirements.outputs.checks_passed }}
          checks_failed: ${{ steps.requirements.outputs.checks_failed }}
          checks_skipped: ${{ steps.requirements.outputs.checks_skipped }}
          pr_number: ${{ inputs.pr_number }}
          sha: ${{ inputs.sha }}
          github_token: ${{ github.token }}
          prompt_file: .constellos/agents/requirements.md

      # Code quality reviewer
      - name: Run code-quality review
        id: code-quality
        if: matrix.agent == 'code-quality'
        uses: constellos/github-agents/.github/actions/code-quality-reviewer@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ github.token }}

      - name: Post code-quality comment
        if: matrix.agent == 'code-quality'
        uses: constellos/github-agents/.github/actions/review-comment@main
        with:
          review_name: Code Quality
          passed: ${{ steps.code-quality.outputs.passed }}
          result_json: ${{ steps.code-quality.outputs.result }}
          checks_passed: ${{ steps.code-quality.outputs.checks_passed }}
          checks_failed: ${{ steps.code-quality.outputs.checks_failed }}
          checks_skipped: ${{ steps.code-quality.outputs.checks_skipped }}
          pr_number: ${{ inputs.pr_number }}
          sha: ${{ inputs.sha }}
          github_token: ${{ github.token }}
          prompt_file: .constellos/agents/code-quality.md

      # Context reviewer (stub)
      - name: Run context review
        id: context
        if: matrix.agent == 'context'
        uses: constellos/github-agents/.github/actions/context-reviewer@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ github.token }}

      - name: Post context comment
        if: matrix.agent == 'context'
        uses: constellos/github-agents/.github/actions/review-comment@main
        with:
          review_name: Context
          passed: ${{ steps.context.outputs.passed }}
          result_json: ${{ steps.context.outputs.result }}
          checks_passed: ${{ steps.context.outputs.checks_passed }}
          checks_failed: ${{ steps.context.outputs.checks_failed }}
          checks_skipped: ${{ steps.context.outputs.checks_skipped }}
          pr_number: ${{ inputs.pr_number }}
          sha: ${{ inputs.sha }}
          github_token: ${{ github.token }}
          prompt_file: .constellos/agents/context.md
