name: Deployment CI

on:
  workflow_run:
    workflows: ["Code Reviews"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  deployments: write

concurrency:
  group: deployment-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      has_deployment: ${{ steps.detect.outputs.has_deployment }}
      deployment_enabled: ${{ steps.detect.outputs.deployment_enabled }}
      has_vercel: ${{ steps.detect.outputs.has_vercel }}
      has_supabase: ${{ steps.detect.outputs.has_supabase }}
      has_cloudflare: ${{ steps.detect.outputs.has_cloudflare }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.35.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Detect deployment config
        id: detect
        run: |
          HAS_DEPLOYMENT=false
          DEPLOYMENT_ENABLED=false
          HAS_VERCEL=false
          HAS_SUPABASE=false
          HAS_CLOUDFLARE=false

          # Check for config files
          [ -f "vercel.json" ] && HAS_VERCEL=true && HAS_DEPLOYMENT=true
          [ -d "supabase" ] && HAS_SUPABASE=true && HAS_DEPLOYMENT=true
          [ -f "wrangler.toml" ] && HAS_CLOUDFLARE=true && HAS_DEPLOYMENT=true

          # Check .github/ci-config.yml (REQUIRED for enabling deployments)
          if [ -f ".github/ci-config.yml" ]; then
            DEPLOY_ENABLED=$(yq '.ci.deployment.enabled // false' .github/ci-config.yml)
            if [ "$DEPLOY_ENABLED" = "true" ]; then
              DEPLOYMENT_ENABLED=true
            fi
          fi

          echo "has_deployment=$HAS_DEPLOYMENT" >> $GITHUB_OUTPUT
          echo "deployment_enabled=$DEPLOYMENT_ENABLED" >> $GITHUB_OUTPUT
          echo "has_vercel=$HAS_VERCEL" >> $GITHUB_OUTPUT
          echo "has_supabase=$HAS_SUPABASE" >> $GITHUB_OUTPUT
          echo "has_cloudflare=$HAS_CLOUDFLARE" >> $GITHUB_OUTPUT

  # Monitor Vercel deployment (triggered by Vercel GitHub integration)
  vercel-preview:
    name: Monitor Vercel Preview Deployment
    needs: check-config
    if: needs.check-config.outputs.has_vercel == 'true' && needs.check-config.outputs.deployment_enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Vercel deploys automatically via GitHub integration
      # We MONITOR the deployment and fail CI if it fails

      - name: Wait for Vercel deployment
        uses: UnlyEd/github-action-await-vercel@v1
        id: await-vercel
        with:
          timeout: 600  # 10 minutes
          poll-interval: 5  # seconds
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Check deployment status
        if: steps.await-vercel.outcome != 'success'
        run: |
          echo "::error::Vercel deployment failed or timed out"
          exit 1

      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOY_URL="${{ steps.await-vercel.outputs.url }}"
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "### ✅ Vercel Preview Deployed\n\nDeployed to: $DEPLOY_URL"

  # Monitor Supabase branch deployment (triggered by Supabase integration)
  supabase-migrations:
    name: Monitor Supabase Branch
    needs: check-config
    if: needs.check-config.outputs.has_supabase == 'true' && needs.check-config.outputs.deployment_enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # Supabase creates preview branches automatically
      # We check the branch status to ensure migrations succeeded

      - name: Wait for Supabase branch to be healthy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          BRANCH_NAME="preview-pr-${{ github.event.pull_request.number }}"
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_ID }}"

          echo "Waiting for Supabase branch '$BRANCH_NAME' to be healthy..."

          TIMEOUT=300  # 5 minutes
          POLL_INTERVAL=15
          START_TIME=$(date +%s)

          while true; do
            # Get branch status
            STATUS=$(supabase branches get "$BRANCH_NAME" --project-ref $PROJECT_REF --output json 2>/dev/null | \
              jq -r '.database.status' || echo "NOT_FOUND")

            echo "Branch status: $STATUS"

            case $STATUS in
              ACTIVE_HEALTHY)
                echo "✅ Supabase branch is healthy"
                exit 0
                ;;
              FAILED|REMOVED)
                echo "❌ Supabase branch failed or was removed"
                exit 1
                ;;
              COMING_UP|GOING_DOWN|UPGRADING|RESTORING)
                echo "Branch is transitioning..."
                ;;
              NOT_FOUND)
                echo "Waiting for branch to be created..."
                ;;
            esac

            # Check timeout
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            if [ $ELAPSED -gt $TIMEOUT ]; then
              echo "❌ Branch health check timed out after ${TIMEOUT}s"
              exit 1
            fi

            sleep $POLL_INTERVAL
          done

      - name: Comment Supabase branch on PR
        if: github.event_name == 'pull_request' && success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="preview-pr-${{ github.event.pull_request.number }}"
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "### ✅ Supabase Branch Healthy\n\nBranch: \`$BRANCH_NAME\`"

  # Monitor Cloudflare Pages deployment (triggered by Cloudflare integration)
  cloudflare-deploy:
    name: Monitor Cloudflare Pages Deployment
    needs: check-config
    if: needs.check-config.outputs.has_cloudflare == 'true' && needs.check-config.outputs.deployment_enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Cloudflare deploys automatically via GitHub integration
      # We poll the Cloudflare API to check deployment status

      - name: Wait for Cloudflare deployment
        id: wait
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        run: |
          # Get latest deployment for this commit
          COMMIT_SHA="${{ github.event.pull_request.head.sha || github.sha }}"

          echo "Waiting for Cloudflare Pages deployment of commit $COMMIT_SHA..."

          TIMEOUT=600
          POLL_INTERVAL=10
          START_TIME=$(date +%s)

          while true; do
            # Get deployments and find the one for this commit
            DEPLOYMENTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$CLOUDFLARE_PROJECT_NAME/deployments" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

            DEPLOYMENT=$(echo "$DEPLOYMENTS" | jq -r ".result[] | select(.deployment_trigger.metadata.commit_hash == \"$COMMIT_SHA\")" | head -1)

            if [ -n "$DEPLOYMENT" ] && [ "$DEPLOYMENT" != "null" ]; then
              DEPLOYMENT_ID=$(echo "$DEPLOYMENT" | jq -r '.id')
              STATUS=$(echo "$DEPLOYMENT" | jq -r '.latest_stage.status')

              echo "Deployment status: $STATUS"

              case $STATUS in
                success)
                  echo "✅ Cloudflare Pages deployment succeeded"
                  DEPLOY_URL=$(echo "$DEPLOYMENT" | jq -r '.url')
                  echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
                  exit 0
                  ;;
                failure)
                  echo "❌ Cloudflare Pages deployment failed"
                  exit 1
                  ;;
                active)
                  echo "Deployment in progress..."
                  ;;
              esac
            else
              echo "Waiting for deployment to start..."
            fi

            # Check timeout
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            if [ $ELAPSED -gt $TIMEOUT ]; then
              echo "❌ Deployment timed out after ${TIMEOUT}s"
              exit 1
            fi

            sleep $POLL_INTERVAL
          done

      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request' && success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOY_URL="${{ steps.wait.outputs.deploy_url }}"
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "### ✅ Cloudflare Pages Deployed\n\nDeployed to: $DEPLOY_URL"

  # Summary job that checks all deployment results
  deployment-summary:
    name: Deployment Summary
    needs: [check-config, vercel-preview, supabase-migrations, cloudflare-deploy]
    if: always() && needs.check-config.outputs.deployment_enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment results
        run: |
          VERCEL_STATUS="${{ needs.vercel-preview.result }}"
          SUPABASE_STATUS="${{ needs.supabase-migrations.result }}"
          CLOUDFLARE_STATUS="${{ needs.cloudflare-deploy.result }}"

          echo "Deployment Results:"
          echo "  Vercel: $VERCEL_STATUS"
          echo "  Supabase: $SUPABASE_STATUS"
          echo "  Cloudflare: $CLOUDFLARE_STATUS"

          # Fail if any deployment failed
          if [ "$VERCEL_STATUS" = "failure" ] || \
             [ "$SUPABASE_STATUS" = "failure" ] || \
             [ "$CLOUDFLARE_STATUS" = "failure" ]; then
            echo "::error::One or more deployments failed"
            exit 1
          fi

  # No-op job for repos without deployments
  no-deployment-needed:
    name: No Deployment Configured
    needs: check-config
    if: needs.check-config.outputs.deployment_enabled != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Skip deployments
        run: |
          echo "ℹ️  Deployments are disabled for this repository"
          echo "This repo has deployment.enabled: false in .github/ci-config.yml"
          echo "Repos without deployments (like claude-code-actions, claude-code-plugins) skip this workflow"
